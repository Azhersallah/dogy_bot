<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App with Firestore and Realtime Database</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .auth-info {
            margin-top: 20px;
        }
        .status {
            font-size: 1.2em;
            color: green;
        }
        .error-status {
            font-size: 1.2em;
            color: red;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCNGOAnTyQ-z91is5nku_vKQMIXMsjH3sg",
            authDomain: "ttaskk-a50e4.firebaseapp.com",
            databaseURL: "https://ttaskk-a50e4-default-rtdb.firebaseio.com",
            projectId: "ttaskk-a50e4",
            storageBucket: "ttaskk-a50e4.appspot.com",
            messagingSenderId: "213200371465",
            appId: "1:213200371465:web:2cee76953abdc5d8049dd8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const database = getDatabase(app);

        // Initialize the Telegram Web App
        const tg = window.Telegram.WebApp;

        // Get the initData from Telegram
        const initData = tg.initData;

        if (initData) {
            const user = tg.initDataUnsafe.user;

            if (user) {
                const telegramId = user.id;

                // Display user information
                document.getElementById('status').innerHTML = `
                    <div class="auth-info">
                        <p>Authenticated as: ${user.first_name} ${user.last_name || ''}</p>
                        <p>Username: ${user.username}</p>
                        <p>User ID: ${telegramId}</p>
                    </div>
                `;

                // Send username and user ID to Firestore
                sendUserDataToFirestore(user.username, telegramId)
                    .then(() => {
                        // Check if user ID exists in Firestore before sending to Realtime Database
                        return checkUserExistsInFirestore(telegramId);
                    })
                    .then((exists) => {
                        if (exists) {
                            // Send other user data to Realtime Database
                            sendUserDataToDatabase(user.username, telegramId);
                        } else {
                            document.getElementById('status').innerHTML += `
                                <div class="error-status">User ID does not exist in Firestore</div>
                            `;
                        }
                    });
            } else {
                document.getElementById('status').innerHTML = `<div class="error-status">Failed to get user data</div>`;
            }
        } else {
            document.getElementById('status').innerHTML = `<div class="error-status">No init data found</div>`;
        }

        function sendUserDataToFirestore(username, telegramId) {
            const userData = {
                username: username,
                telegramId: telegramId,
            };

            // Set user data in Firestore
            return setDoc(doc(db, "user-info", telegramId.toString()), userData)
                .then(() => {
                    console.log('Username and user ID saved to Firestore:', userData);
                    showSuccessMessage('User data sent to Firestore successfully!');
                })
                .catch((error) => {
                    console.error('Error saving user data to Firestore:', error);
                });
        }

        function checkUserExistsInFirestore(telegramId) {
            return doc(db, "user-info", telegramId.toString()).get().then((doc) => {
                return doc.exists;
            }).catch((error) => {
                console.error('Error checking user existence in Firestore:', error);
                return false;
            });
        }

        function sendUserDataToDatabase(username, telegramId) {
            const userData = {
                username: username,
                telegramId: telegramId,
                user_level: 1,
                points: 0,
                booster: 3,
                slider: 1000,
                booster_is_on: false,
                booster_start: "",
                booster_end: ""
            };

            // Set user data in Realtime Database
            set(ref(database, `user-info/${telegramId}`), userData)
                .then(() => {
                    console.log('User data saved to Realtime Database:', userData);
                    showSuccessMessage('User data sent to Realtime Database successfully!');
                })
                .catch((error) => {
                    console.error('Error saving user data to Realtime Database:', error);
                });
        }

        function showSuccessMessage(message) {
            const successMessage = document.createElement('div');
            successMessage.textContent = message;
            successMessage.style.color = 'green';
            document.body.appendChild(successMessage);
        }
    </script>
</head>
<body>
    <h1>Telegram Web App Authentication</h1>
    <div id="status" class="status">Loading...</div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
