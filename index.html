<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App Authentication with Firebase</title>
    <style>
        /* Basic styling for the display */
        body {
            background-color:tomato;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .auth-info {
            margin-top: 20px;
        }
        .login-status {
            font-size: 1.2em;
            color: green;
        }
        .error-status {
            font-size: 1.2em;
            color: red;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, fetchSignInMethodsForEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCNGOAnTyQ-z91is5nku_vKQMIXMsjH3sg",
            authDomain: "ttaskk-a50e4.firebaseapp.com",
            projectId: "ttaskk-a50e4",
            storageBucket: "ttaskk-a50e4.appspot.com",
            messagingSenderId: "213200371465",
            appId: "1:213200371465:web:2cee76953abdc5d8049dd8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Initialize the Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // Get the initData from Telegram
        const initData = tg.initData;

        let currentUserData = null;

        if (initData) {
            // Extract user data from initDataUnsafe (non-validated version)
            const user = tg.initDataUnsafe.user;

            if (user) {
                const email = `${user.id}@gmail.com`;
                const password = `${user.id}`;

                // Display user information
                document.getElementById('status').innerHTML = `
                    <div class="auth-info">
                        <p>Authenticated as: ${user.first_name} ${user.last_name || ''}</p>
                        <p>Username: ${user.username}</p>
                        <p>User ID: ${user.id}</p>
                        <p>Email: ${email}</p>
                    </div>
                `;

                // Check if user is already authenticated
                onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        // User is already signed in
                        currentUserData = currentUser;
                        showSuccessMessage('User is already logged in!');
                    } else {
                        // Check if user already exists
                        fetchSignInMethodsForEmail(auth, email)
                            .then((methods) => {
                                if (methods.length > 0) {
                                    // User exists, log them in
                                    signInWithEmailAndPassword(auth, email, password)
                                        .then((userCredential) => {
                                            currentUserData = userCredential.user;
                                            console.log('User logged in:', currentUserData);
                                            showSuccessMessage('User logged in successfully!');
                                        })
                                        .catch((error) => {
                                            const errorMessage = error.message;
                                            console.error('Error logging in:', errorMessage);
                                            document.getElementById('status').innerHTML = `<div class="error-status">Error: ${errorMessage}</div>`;
                                        });
                                } else {
                                    // User does not exist, create a new one
                                    createUserWithEmailAndPassword(auth, email, password)
                                        .then((userCredential) => {
                                            currentUserData = userCredential.user;
                                            console.log('User registered:', currentUserData);
                                            showSuccessMessage('User registered successfully!');
                                        })
                                        .catch((error) => {
                                            const errorMessage = error.message;
                                            console.error('Error registering:', errorMessage);
                                            document.getElementById('status').innerHTML = `<div class="error-status">Error: ${errorMessage}</div>`;
                                        });
                                }
                            })
                            .catch((error) => {
                                console.error('Error checking sign-in methods:', error);
                                document.getElementById('status').innerHTML = `<div class="error-status">Error: ${error.message}</div>`;
                            });
                    }
                });
            } else {
                document.getElementById('status').innerHTML = `<div class="error-status">Failed to get user data</div>`;
            }
        } else {
            document.getElementById('status').innerHTML = `<div class="error-status">No init data found</div>`;
        }

        function sendUserDataToFirestore() {
            if (!currentUserData) {
                console.error('No user is logged in. Cannot send data to Firestore.');
                return;
            }

            const username = tg.initDataUnsafe.user.username || "Unknown";
            const telegramId = tg.initDataUnsafe.user.id;
            const uid = currentUserData.email; // Use the email as UID

            const userData = {
                username: username,
                telegramId: telegramId,
                level: 1,
                points: 0
            };

            // Set user data in Firestore
            setDoc(doc(db, 'user-info', uid), userData)
                .then(() => {
                    console.log('User data saved to Firestore:', userData);
                    showSuccessMessage('User data sent to Firestore successfully!');
                })
                .catch((error) => {
                    console.error('Error saving user data to Firestore:', error);
                });
        }

        function showSuccessMessage(message) {
            const successMessage = document.createElement('div');
            successMessage.textContent = message;
            successMessage.style.color = 'green';
            document.body.appendChild(successMessage);
        }

        // Call this function to send user data when needed
        function onSendUserData() {
            sendUserDataToFirestore();
        }
    </script>
</head>
<body>
    <h1>Telegram Web App Authentication</h1>
    <div id="status" class="login-status">Loading...</div>
    <button onclick="onSendUserData()">Send User Data to Firestore</button>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
