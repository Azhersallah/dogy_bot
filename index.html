<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App with Firestore and Realtime Database</title>
    <style>
        body {
            background-color: grey;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .auth-info {
            margin-top: 20px;
        }
        .status {
            font-size: 1.2em;
            color: green;
        }
        .error-status {
            font-size: 1.2em;
            color: red;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const database = getDatabase(app);

        // Initialize the Telegram Web App
        const tg = window.Telegram.WebApp;

        // Get the initData from Telegram
        const initData = tg.initData;

        if (initData) {
            const user = tg.initDataUnsafe.user;

            if (user) {
                const telegramId = user.id;

                // Display user information
                document.getElementById('status').innerHTML = `
                    <div class="auth-info">
                        <p>Authenticated as: ${user.first_name} ${user.last_name || ''}</p>
                        <p>Username: ${user.username}</p>
                        <p>User ID: ${telegramId}</p>
                    </div>
                `;

                // Check if user exists in Firestore
                checkUserInFirestore(telegramId);
            } else {
                document.getElementById('status').innerHTML = `<div class="error-status">Failed to get user data</div>`;
            }
        } else {
            document.getElementById('status').innerHTML = `<div class="error-status">No init data found</div>`;
        }

        function checkUserInFirestore(telegramId) {
            const userDocRef = doc(db, "user-info", telegramId.toString());

            getDoc(userDocRef).then((docSnapshot) => {
                if (docSnapshot.exists()) {
                    // User exists in Firestore, proceed to send data to Realtime Database
                    sendUserDataToDatabase(telegramId);
                } else {
                    // User not found in Firestore
                    document.getElementById('status').innerHTML = `<div class="error-status">User not found in Firestore</div>`;
                }
            }).catch((error) => {
                console.error('Error fetching user from Firestore:', error);
                document.getElementById('status').innerHTML = `<div class="error-status">Error: ${error.message}</div>`;
            });
        }

        function sendUserDataToDatabase(telegramId) {
            const userData = {
                telegramId: telegramId,
                username: "example_user",  // You can modify this as needed
                points: 0,
                createdAt: new Date().toISOString()
            };

            // Set user data in Realtime Database
            set(ref(database, `user-info/${telegramId}`), userData)
                .then(() => {
                    console.log('User data saved to Realtime Database:', userData);
                    document.getElementById('status').innerHTML = `<div class="status">User data sent to Realtime Database successfully!</div>`;
                })
                .catch((error) => {
                    console.error('Error saving user data to Realtime Database:', error);
                    document.getElementById('status').innerHTML = `<div class="error-status">Error: ${error.message}</div>`;
                });
        }
    </script>
</head>
<body>
    <h1>Telegram Web App Authentication</h1>
    <div id="status" class="status">Loading...</div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
